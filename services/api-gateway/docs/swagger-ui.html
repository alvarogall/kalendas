<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kalendas API Gateway - Documentaci贸n OpenAPI</title>
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/swagger-ui-dist@5.10.0/swagger-ui.css">
  <style>
    html {
      box-sizing: border-box;
      overflow: -moz-scrollbars-vertical;
      overflow-y: scroll;
    }

    *,
    *:before,
    *:after {
      box-sizing: inherit;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: #fafafa;
    }

    .topbar {
      background-color: #1b1b1b;
      padding: 10px 20px;
    }

    .topbar .topbar-wrapper {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .topbar .link {
      color: #fff;
      text-decoration: none;
      font-size: 1.2em;
      font-weight: bold;
    }

    .topbar .link:hover {
      color: #89bf04;
    }

    #swagger-ui {
      max-width: 1460px;
      margin: 0 auto;
    }

    .swagger-ui .topbar {
      display: none;
    }

    .info {
      margin: 20px 0;
    }

    .info .title {
      font-size: 2em;
      color: #3b4151;
    }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="topbar-wrapper">
      <a href="#" class="link"> Kalendas API Gateway</a>
      <span style="color: #fff;">Especificaci贸n OpenAPI 3.0</span>
    </div>
  </div>

  <div id="swagger-ui"></div>

  <script src="https://cdn.jsdelivr.net/npm/swagger-ui-dist@5.10.0/swagger-ui-bundle.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/swagger-ui-dist@5.10.0/swagger-ui-standalone-preset.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
  <script id="openapi-spec" type="text/yaml">
openapi: 3.0.3
info:
  title: Kalendas API Gateway
  description: |
    Especificaci贸n OpenAPI del API Gateway de Kalendas. Todas las operaciones se exponen bajo el gateway y se encaminan a los microservicios internos (calendars, events, comments, notifications).

    Notas:
    - Todas las fechas est谩n en ISO 8601.
    - Los par谩metros de b煤squeda se pasan como query string en el endpoint ra铆z de cada recurso.
    - Las respuestas devuelven id (string) en lugar de _id.
  version: 1.0.0
  contact:
    name: Equipo Kalendas
servers:
  - url: https://kalendas-gateway-8i8x.onrender.com
    description: Producci贸n (Render)
  - url: http://localhost:8080
    description: Desarrollo local (API Gateway)

tags:
  - name: Auth
    description: Autenticaci贸n y Tokens
  - name: Dropbox
    description: Subida de archivos a Dropbox
  - name: Calendars
    description: Gesti贸n y consulta de calendarios
  - name: Preferences
    description: Preferencias de usuario (calendarios seguidos/seleccionados)
  - name: Events
    description: Gesti贸n y consulta de eventos
  - name: Comments
    description: Gesti贸n y consulta de comentarios
  - name: Notifications
    description: Gesti贸n y consulta de notificaciones
  - name: Health
    description: Estado del gateway

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        JWT emitido por el gateway. Se puede enviar como Authorization: Bearer <token>.
    cookieAuth:
      type: apiKey
      in: cookie
      name: auth_token
      description: |
        Cookie httpOnly auth_token establecida por /api/auth/login. En navegadores, el gateway tambi茅n propaga esta cookie como Authorization a los microservicios.
  schemas:
    ErrorResponse:
      type: object
      properties:
        error:
          type: string
        detail:
          type: string
          nullable: true
    HealthResponse:
      type: object
      properties:
        status:
          type: string
          example: ok
        gateway:
          type: object
          properties:
            googleClientIdConfigured:
              type: boolean
            frontendUrl:
              type: string
            renderGitCommit:
              type: string
              nullable: true
            renderServiceName:
              type: string
              nullable: true
        services:
          type: object
          additionalProperties:
            type: string
        servicesRaw:
          type: object
          additionalProperties:
            type: string

    Calendar:
      type: object
      properties:
        id: { type: string }
        title: { type: string }
        organizer: { type: string }
        organizerEmail: { type: string, format: email }
        description: { type: string }
        startDate: { type: string, format: date-time }
        endDate: { type: string, format: date-time, nullable: true }
        keywords:
          type: array
          items: { type: string }
        notificationChannel:
          type: string
          enum: [email, in-app]
        parentId:
          type: string
          nullable: true
        subCalendars:
          type: array
          items:
            oneOf:
              - type: string
              - $ref: '#/components/schemas/Calendar'
        sourceUrl:
          type: string
          nullable: true
        lastSyncedAt:
          type: string
          format: date-time
          nullable: true
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }
    CalendarCreate:
      type: object
      required: [title, organizer, organizerEmail, startDate]
      properties:
        title: { type: string }
        organizer: { type: string }
        organizerEmail: { type: string, format: email }
        description: { type: string }
        startDate: { type: string, format: date-time }
        endDate: { type: string, format: date-time }
        keywords:
          type: array
          items: { type: string }
        notificationChannel:
          type: string
          enum: [email, in-app]
          default: email
        parentId:
          type: string
          nullable: true
    CalendarUpdate:
      allOf:
        - $ref: '#/components/schemas/CalendarCreate'

    Coordinates:
      type: object
      properties:
        type:
          type: string
          enum: ['Point']
        coordinates:
          type: array
          description: '[longitud, latitud]'
          items:
            type: number
          minItems: 2
          maxItems: 2

    Event:
      type: object
      properties:
        id: { type: string }
        title: { type: string }
        startTime: { type: string, format: date-time }
        endTime: { type: string, format: date-time }
        location: { type: string }
        coordinates:
          $ref: '#/components/schemas/Coordinates'
        organizer: { type: string }
        calendar: { type: string, description: 'ID de Calendar' }
        description: { type: string }
        images:
          type: array
          items: { type: string }
        attachments:
          type: array
          items: { type: string }
        mapLink: { type: string }
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }
    EventCreate:
      type: object
      required: [title, startTime, endTime, location, calendar]
      properties:
        title: { type: string }
        startTime: { type: string, format: date-time }
        endTime: { type: string, format: date-time }
        location: { type: string }
        coordinates:
          $ref: '#/components/schemas/Coordinates'
        calendar: { type: string }
        description: { type: string }
        images:
          type: array
          items: { type: string }
        attachments:
          type: array
          items: { type: string }
        mapLink: { type: string }
    EventUpdate:
      allOf:
        - $ref: '#/components/schemas/EventCreate'

    Comment:
      type: object
      properties:
        id: { type: string }
        eventId: { type: string }
        user: { type: string }
        text: { type: string }
        date: { type: string, format: date-time }
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }
    CommentCreate:
      type: object
      required: [eventId, user, text]
      properties:
        eventId: { type: string }
        user: { type: string }
        text: { type: string }
    CommentUpdate:
      allOf:
        - $ref: '#/components/schemas/CommentCreate'

    Notification:
      type: object
      properties:
        id: { type: string }
        eventId: { type: string }
        calendarId: { type: string }
        channel: { type: string, enum: [email, in-app] }
        recipientEmail: { type: string, format: email }
        message: { type: string }
        read: { type: boolean }
        status: { type: string, enum: [pending, sent, error] }
        attempts: { type: integer }
        lastError: { type: string, nullable: true }
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }
    NotificationCreate:
      type: object
      required: [eventId, calendarId, commenterName]
      properties:
        eventId: { type: string }
        calendarId: { type: string }
        commenterName: { type: string }

paths:
  /api/auth/login:
    post:
      tags: [Auth]
      summary: Iniciar sesi贸n con Google ID Token
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                token:
                  type: string
                  description: Google ID Token
      responses:
        '200':
          description: Login exitoso
          content:
            application/json:
              schema:
                type: object
                properties:
                  email: { type: string }
                  name: { type: string }
                  isAdmin: { type: boolean }
                  token: { type: string, description: JWT para uso en Authorization si no se usan cookies }
                  message: { type: string }
        '401':
          description: Token inv谩lido
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ErrorResponse' }

  /api/auth/logout:
    post:
      tags: [Auth]
      summary: Cerrar sesi贸n
      responses:
        '200':
          description: Logout exitoso

  /api/token:
    get:
      tags: [Auth]
      summary: Obtener token de sesi贸n actual
      description: Devuelve el token JWT almacenado en la cookie httpOnly. til para pruebas externas.
      responses:
        '200':
          description: Token recuperado
          content:
            application/json:
              schema:
                type: object
                properties:
                  token: { type: string }
        '401':
          description: No autenticado
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ErrorResponse' }

  /api/dropbox/upload:
    post:
      tags: [Dropbox]
      summary: Subir archivo a Dropbox
      requestBody:
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
      responses:
        '200':
          description: Archivo subido
          content:
            application/json:
              schema:
                type: object
                properties:
                  url: { type: string }
        '400':
          description: Falta el archivo
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ErrorResponse' }

  /api/dropbox/delete:
    post:
      tags: [Dropbox]
      summary: Eliminar archivo de Dropbox por shared link
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [sharedUrl]
              properties:
                sharedUrl:
                  type: string
                  description: URL compartida de Dropbox devuelta por /api/dropbox/upload
      responses:
        '200':
          description: Eliminado
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
        '400':
          description: Par谩metros inv谩lidos
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ErrorResponse' }

  /health:
    get:
      tags: [Health]
      summary: Comprobar estado del gateway
      description: Devuelve estado y URLs configuradas de los servicios aguas abajo.
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/HealthResponse' }
              examples:
                ejemplo:
                  value:
                    status: ok
                    gateway:
                      googleClientIdConfigured: true
                      frontendUrl: http://localhost:5173
                      renderGitCommit: null
                      renderServiceName: null
                    services:
                      calendars: http://localhost:3001
                      events: http://localhost:3002
                      comments: http://localhost:3003
                      notifications: http://localhost:3004

  /api/health:
    get:
      tags: [Health]
      summary: Comprobar estado del gateway (alias)
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/HealthResponse' }

  /api/version:
    get:
      tags: [Health]
      summary: Informaci贸n de versi贸n/despliegue del gateway
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  name: { type: string }
                  renderGitCommit: { type: string, nullable: true }
                  renderServiceName: { type: string, nullable: true }

  /api/calendars:
    get:
      tags: [Calendars]
      summary: Listar calendarios con filtros
      description: |
        Devuelve la lista de calendarios. Filtros admitidos (combinables):
        - `title`: coincidencia parcial, insensible a may煤sculas.
        - `organizer`: coincidencia parcial, insensible a may煤sculas.
        - `startDate`/`endDate`: rango en la fecha de inicio del calendario.
        - `hasEventsByOrganizer`: restringe a calendarios que tengan eventos cuyo `organizer` sea el indicado.
        - `commentedBy`: restringe a calendarios que tengan eventos con comentarios del usuario indicado.
      parameters:
        - in: query
          name: title
          schema: { type: string }
          description: Texto a buscar en el t铆tulo
        - in: query
          name: organizer
          schema: { type: string }
          description: Texto a buscar en el organizador
        - in: query
          name: startDate
          schema: { type: string, format: date-time }
        - in: query
          name: endDate
          schema: { type: string, format: date-time }
        - in: query
          name: hasEventsByOrganizer
          schema: { type: string }
          description: Organizador de eventos requerido
        - in: query
          name: commentedBy
          schema: { type: string }
          description: Usuario que ha comentado en eventos del calendario
        - in: query
          name: includeAll
          schema: { type: string, enum: ['true','false'] }
          description: Si es true, incluye tambi茅n subcalendarios (por defecto solo calendarios ra铆z)
      responses:
        '200':
          description: Lista de calendarios
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/Calendar' }
              examples:
                ejemplo:
                  value:
                    - id: 64f1a0c2a0b1c2d3e4f56789
                      title: Conferencias 2025
                      organizer: Escuela de Ingenier铆a
                      organizerEmail: org@example.com
                      description: Agenda acad茅mica
                      startDate: 2025-01-01T00:00:00.000Z
                      endDate: 2025-12-31T23:59:59.000Z
                      keywords: [ingenier铆a, conferencias]
                      notificationChannel: email
                      createdAt: 2025-01-02T10:00:00.000Z
                      updatedAt: 2025-01-02T10:00:00.000Z
    post:
      tags: [Calendars]
      summary: Crear calendario
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/CalendarCreate' }
            examples:
              ejemplo:
                value:
                  title: Conferencias 2025
                  organizer: Escuela de Ingenier铆a
                  organizerEmail: org@example.com
                  description: Agenda acad茅mica
                  startDate: 2025-01-01T00:00:00.000Z
                  endDate: 2025-12-31T23:59:59.000Z
                  keywords: [ingenier铆a, conferencias]
                  notificationChannel: email
      responses:
        '201':
          description: Calendario creado
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Calendar' }

  /api/calendars/import:
    post:
      tags: [Calendars]
      summary: Importar calendario desde URL ICS
      description: |
        Crea un calendario y crea eventos a partir de un feed ICS.
        Requiere autenticaci贸n (para fijar organizer/organizerEmail como el usuario autenticado).
      security:
        - bearerAuth: []
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [url]
              properties:
                url: { type: string, description: URL p煤blica https://... del ICS }
                provider: { type: string, description: Etiqueta informativa (p.ej. Google/Outlook/Web) }
      responses:
        '201':
          description: Importado
          content:
            application/json:
              schema:
                type: object
                properties:
                  message: { type: string }
                  calendar: { $ref: '#/components/schemas/Calendar' }
                  eventsFound: { type: integer }
                  eventsCreated: { type: integer }
                  eventsFailed: { type: integer }
                  sampleErrors:
                    type: array
                    items: { type: string }
                  eventsTruncated: { type: boolean }
        '400':
          description: Petici贸n inv谩lida
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ErrorResponse' }
        '401':
          description: No autenticado
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ErrorResponse' }

  /api/calendars/{id}/sync:
    post:
      tags: [Calendars]
      summary: Sincronizar un calendario importado desde su URL ICS
      security:
        - bearerAuth: []
        - cookieAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Sincronizaci贸n completada
          content:
            application/json:
              schema:
                type: object
                properties:
                  message: { type: string }
                  eventsCreated: { type: integer }
                  eventsFailed: { type: integer }
                  sampleErrors:
                    type: array
                    items: { type: string }
                  lastSyncedAt: { type: string, format: date-time }
        '400':
          description: No es importado o petici贸n inv谩lida
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ErrorResponse' }
        '401':
          description: No autenticado
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ErrorResponse' }
        '403':
          description: No autorizado
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ErrorResponse' }
        '404':
          description: No encontrado
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ErrorResponse' }

  /api/calendars/{id}:
    get:
      tags: [Calendars]
      summary: Obtener calendario por ID
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string, pattern: '^[0-9a-fA-F]{24}$' }
      responses:
        '200': { description: OK, content: { application/json: { schema: { $ref: '#/components/schemas/Calendar' } } } }
        '404': { description: No encontrado }
    put:
      tags: [Calendars]
      summary: Actualizar calendario por ID
      security:
        - bearerAuth: []
        - cookieAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/CalendarUpdate' }
      responses:
        '200': { description: OK, content: { application/json: { schema: { $ref: '#/components/schemas/Calendar' } } } }
        '401':
          description: No autenticado
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ErrorResponse' }
        '403':
          description: No autorizado
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ErrorResponse' }
        '404': { description: No encontrado }
    delete:
      tags: [Calendars]
      summary: Eliminar calendario por ID
      security:
        - bearerAuth: []
        - cookieAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      responses:
        '204': { description: Eliminado }
        '401':
          description: No autenticado
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ErrorResponse' }
        '403':
          description: No autorizado
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ErrorResponse' }
        '404': { description: No encontrado }

  /api/calendars/{id}/subcalendars:
    get:
      tags: [Calendars]
      summary: Listar subcalendarios de un calendario
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/Calendar' }
        '404': { description: No encontrado }

  /api/events:
    get:
      tags: [Events]
      summary: Listar eventos con filtros
      description: |
        Filtros admitidos:
        - `description`: busca en `title` y `description` (regex segura, insensible a may煤sculas).
        - `organizer`: exacto.
        - `calendarId` o `calendar`: ID del calendario.
        - `startAfter` / `startBefore`: rango por `startTime`.
        - `ids`: lista de IDs separados por comas (m谩ximo 200 recomendado).
        - `commentedBy`: restringe a eventos comentados por un usuario concreto.
      parameters:
        - in: query
          name: description
          schema: { type: string }
        - in: query
          name: organizer
          schema: { type: string }
        - in: query
          name: calendarId
          schema: { type: string }
        - in: query
          name: calendar
          schema: { type: string }
        - in: query
          name: startAfter
          schema: { type: string, format: date-time }
        - in: query
          name: startBefore
          schema: { type: string, format: date-time }
        - in: query
          name: ids
          schema: { type: string }
          description: CSV de IDs de evento
        - in: query
          name: commentedBy
          schema: { type: string }
      responses:
        '200':
          description: Lista de eventos
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/Event' }
    post:
      tags: [Events]
      summary: Crear evento
      description: Requiere autenticaci贸n. El organizer se fija al email del usuario autenticado.
      security:
        - bearerAuth: []
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/EventCreate' }
            examples:
              ejemplo:
                value:
                  title: Jornada de puertas abiertas
                  startTime: 2025-03-10T09:00:00.000Z
                  endTime: 2025-03-10T12:00:00.000Z
                  location: Aula Magna
                  organizer: Escuela de Ingenier铆a
                  calendar: 64f1a0c2a0b1c2d3e4f56789
                  description: Bienvenida a nuevos estudiantes
      responses:
        '201': { description: Creado, content: { application/json: { schema: { $ref: '#/components/schemas/Event' } } } }
        '400':
          description: Petici贸n inv谩lida (validaci贸n)
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ErrorResponse' }
        '401':
          description: No autenticado
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ErrorResponse' }
        '403':
          description: No autorizado (no eres owner del calendario)
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ErrorResponse' }
    delete:
      tags: [Events]
      summary: Eliminar todos los eventos de un calendario
      description: Usado por sincronizaci贸n/importaci贸n. Elimina por calendarId.
      parameters:
        - in: query
          name: calendarId
          required: true
          schema: { type: string }
      responses:
        '204': { description: Eliminado }
        '400':
          description: Falta calendarId
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ErrorResponse' }

  /api/events/{id}:
    get:
      tags: [Events]
      summary: Obtener evento por ID
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      responses:
        '200': { description: OK, content: { application/json: { schema: { $ref: '#/components/schemas/Event' } } } }
        '404': { description: No encontrado }
    put:
      tags: [Events]
      summary: Actualizar evento por ID
      security:
        - bearerAuth: []
        - cookieAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/EventUpdate' }
      responses:
        '200': { description: OK, content: { application/json: { schema: { $ref: '#/components/schemas/Event' } } } }
        '404': { description: No encontrado }
    delete:
      tags: [Events]
      summary: Eliminar evento por ID
      security:
        - bearerAuth: []
        - cookieAuth: []
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      responses:
        '204': { description: Eliminado }
        '404': { description: No encontrado }

  /api/events/{id}/comments:
    get:
      tags: [Events]
      summary: Listar comentarios de un evento (proxy a comment-service)
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/Comment' }
        '404': { description: No encontrado }

  /api/events/{id}/calendar:
    get:
      tags: [Events]
      summary: Obtener el calendario asociado a un evento
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/Calendar'
                  - type: object
                    properties:
                      calendarId: { type: string }
        '404': { description: No encontrado }

  /api/comments:
    get:
      tags: [Comments]
      summary: Listar comentarios con filtros
      description: |
        Filtros admitidos:
        - `eventId`: por evento.
        - `user`: por autor de comentario.
        - `organizer`: combina con eventos del organizador.
        - `distinctUsers=true`: si se combina con `organizer`, devuelve la lista de usuarios 煤nicos.
      parameters:
        - in: query
          name: eventId
          schema: { type: string }
        - in: query
          name: user
          schema: { type: string }
        - in: query
          name: organizer
          schema: { type: string }
        - in: query
          name: distinctUsers
          schema: { type: string, enum: ['true','false'] }
      responses:
        '200':
          description: Lista de comentarios o de usuarios distintos
          content:
            application/json:
              schema:
                oneOf:
                  - type: array
                    items: { $ref: '#/components/schemas/Comment' }
                  - type: array
                    items:
                      type: object
                      properties:
                        user: { type: string }
    post:
      tags: [Comments]
      summary: Crear comentario (dispara notificaci贸n)
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/CommentCreate' }
            examples:
              ejemplo:
                value:
                  eventId: 64f1a0c2a0b1c2d3e4f56789
                  user: ana.romero
                  text: 隆Nos vemos all铆!
      responses:
        '201': { description: Creado, content: { application/json: { schema: { $ref: '#/components/schemas/Comment' } } } }

  /api/comments/{id}:
    get:
      tags: [Comments]
      summary: Obtener comentario por ID
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      responses:
        '200': { description: OK, content: { application/json: { schema: { $ref: '#/components/schemas/Comment' } } } }
        '404': { description: No encontrado }
    put:
      tags: [Comments]
      summary: Actualizar comentario por ID
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/CommentUpdate' }
      responses:
        '200': { description: OK, content: { application/json: { schema: { $ref: '#/components/schemas/Comment' } } } }
        '404': { description: No encontrado }
    delete:
      tags: [Comments]
      summary: Eliminar comentario por ID
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      responses:
        '405':
          description: Eliminaci贸n deshabilitada
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ErrorResponse' }

  /api/notifications:
    get:
      tags: [Notifications]
      summary: Listar notificaciones con filtros
      description: |
        Filtros admitidos:
        - `eventId`, `calendarId`, `recipientEmail`, `channel`.
        - `organizer`: filtra por eventos cuyo `organizer` coincide.
        - `unread=true`: 煤nicamente no le铆das (para `in-app`).
      parameters:
        - in: query
          name: eventId
          schema: { type: string }
        - in: query
          name: calendarId
          schema: { type: string }
        - in: query
          name: recipientEmail
          schema: { type: string, format: email }
        - in: query
          name: organizer
          schema: { type: string }
        - in: query
          name: channel
          schema: { type: string, enum: ['email','in-app'] }
        - in: query
          name: unread
          schema: { type: string, enum: ['true','false'] }
      responses:
        '200':
          description: Lista de notificaciones
          content:
            application/json:
              schema:
                type: array
                items: { $ref: '#/components/schemas/Notification' }
    post:
      tags: [Notifications]
      summary: Crear notificaci贸n de comentario
      description: Genera una notificaci贸n asociada a un comentario sobre un evento. El servicio completa mensaje, canal y destinatario.
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/NotificationCreate' }
            examples:
              ejemplo:
                value:
                  eventId: 64f1a0c2a0b1c2d3e4f56789
                  calendarId: 64f1a0c2a0b1c2d3e4f56780
                  commenterName: ana.romero
      responses:
        '201': { description: Creado, content: { application/json: { schema: { $ref: '#/components/schemas/Notification' } } } }
        '200':
          description: Saltada (auto-notificaci贸n)
          content:
            application/json:
              schema:
                type: object
                properties:
                  skipped: { type: boolean }
                  reason: { type: string }

  /api/preferences:
    get:
      tags: [Preferences]
      summary: Obtener preferencias del usuario autenticado
      security:
        - bearerAuth: []
        - cookieAuth: []
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  trackedCalendarIds:
                    type: array
                    items: { type: string }
                  selectedCalendarIds:
                    type: array
                    items: { type: string }
        '401':
          description: No autenticado
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ErrorResponse' }
    put:
      tags: [Preferences]
      summary: Guardar preferencias del usuario autenticado
      security:
        - bearerAuth: []
        - cookieAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                trackedCalendarIds:
                  type: array
                  items: { type: string }
                selectedCalendarIds:
                  type: array
                  items: { type: string }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  trackedCalendarIds:
                    type: array
                    items: { type: string }
                  selectedCalendarIds:
                    type: array
                    items: { type: string }
        '401':
          description: No autenticado
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ErrorResponse' }

  /api/notifications/{id}:
    get:
      tags: [Notifications]
      summary: Obtener notificaci贸n por ID
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      responses:
        '200': { description: OK, content: { application/json: { schema: { $ref: '#/components/schemas/Notification' } } } }
        '404': { description: No encontrado }
    delete:
      tags: [Notifications]
      summary: Eliminar notificaci贸n por ID
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      responses:
        '204': { description: Eliminado }
        '404': { description: No encontrado }

  /api/notifications/{id}/read:
    patch:
      tags: [Notifications]
      summary: Marcar notificaci贸n como le铆da
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      responses:
        '200': { description: OK, content: { application/json: { schema: { $ref: '#/components/schemas/Notification' } } } }
        '404': { description: No encontrado }
  </script>

  <script>
    window.onload = function() {
      const openapiYaml = document.getElementById('openapi-spec')?.textContent || '';


      // Usar la especificaci贸n embebida para evitar problemas de CORS/rutas y mantener un HTML autocontenido.
      // Si el YAML embebido tiene un error de parseo, hacemos fallback a ./openapi.yaml.
      let spec = null;
      try {
        spec = jsyaml.load(openapiYaml);
      } catch (err) {
        console.error('Error parseando openapiYaml embebido:', err);
      }

      const ui = SwaggerUIBundle({
        ...(spec ? { spec } : { url: './openapi.yaml' }),
        dom_id: '#swagger-ui',
        deepLinking: true,
        presets: [
          SwaggerUIBundle.presets.apis,
          SwaggerUIStandalonePreset
        ],
        plugins: [
          SwaggerUIBundle.plugins.DownloadUrl
        ],
        layout: "StandaloneLayout",
        defaultModelsExpandDepth: 1,
        defaultModelExpandDepth: 1,
        docExpansion: "list",
        filter: true,
        showRequestHeaders: true,
        tryItOutEnabled: true,
        requestInterceptor: (request) => {
          console.log('Request:', request);
          return request;
        },
        responseInterceptor: (response) => {
          console.log('Response:', response);
          return response;
        }
      });

      window.ui = ui;
    };
  </script>
</body>
</html>
